<html>

<head>
    <title>Custom controls</title>
    <link rel="stylesheet" href="./controls/select/select.css">
    <link rel="stylesheet" href="./controls/range-slider/range-slider.css">
    <link rel="stylesheet" href="./controls/file-picker/file-picker.css">
    <link rel="stylesheet" href="./controls/checkbox/checkbox.css">
    <link rel="stylesheet" href="./theme.css">
    <link rel="stylesheet" href="./validation.css">

    <script src="./controls/file-picker/file-picker.js"></script>
    <script src="./controls/select/select.js"></script>
    <style>
        /* поля которые не надо валидировать */
        input[type=range] ~ .form__label:before,
        input[type=color] ~ .form__label:before {
            content: '';
        }




        /* это селект */
        /* select:required ~ .from__error {
            display: block;
        }

        select:required ~ .form__error,
        select:required ~ .form__label,
        select:required ~ .select-selected {
            color: var(--invalid-accent);
        }

        select:required ~ .select-selected {
            border-color: var(--invalid-accent);
        } */



        /* это фиаско */
        /* input[type=range]:required ~ .from__error {
            display: block;
        }

        input[type=range]:required ~ .form__error,
        input[type=range]:required ~ .form__label,
        input[type=range]:required ~ .select-selected {
            color: var(--invalid-accent);
        }

        input[type=range]:required ~ .select-selected {
            border-color: var(--invalid-accent);
        } */
    </style>
</head>

<body>
    <!-- demo: no-require-dot -->
    <form class="form" action="/action_page.php">
        <h2 class="form__title">Controls cant be handled by CSS only</h2>
        <!-- demo: disabled -->
        <fieldset class="form__fieldset">
            <!-- checkbox -->
            <div class="form__group">
                <span class="form__label">Somethin to check</span>
                <div class="form__group-item">
                    <label class="form__item checkbox" tabindex="0">
                        <input required class="form__input" tabindex="-1" type="checkbox" />
                        <span class="form__label">Checkme</span>
                        <span class="form__input--placeholder"></span>
                    </label>
                    <label class="form__item checkbox" tabindex="0">
                        <input required class="form__input" tabindex="-1" type="checkbox" />
                        <span class="form__label">Checkme</span>
                        <span class="form__input--placeholder"></span>
                    </label>
                </div>
            </div>

            <!-- radio -->
            <div class="form__group">
                <span class="form__label">Somethin to radio</span>
                <div class="form__group-item">
                    <label class="form__item radio" tabindex="0">
                        <input required class="form__input" tabindex="-1" name="radio" type="radio" />
                        <span class="form__label">Me</span>
                        <span class="form__input--placeholder"></span>
                    </label>
                    <label class="form__item radio" tabindex="0">
                        <input required class="form__input" tabindex="-1" name="radio" type="radio" />
                        <span class="form__label">Or me 2</span>
                        <span class="form__input--placeholder"></span>
                    </label>
                </div>
            </div>


            <!-- select -->
            <label class="form__item custom-select">
                <select class="form__input form__input--select" tabindex="-1" required>
                    <option value="">Select car:</option>
                    <option value="1">Audi</option>
                    <option value="2">BMW</option>
                    <option value="3">Citroen</option>
                    <option value="4">Ford</option>
                    <option value="5">Honda</option>
                    <option value="6">Jaguar</option>
                    <option value="7">Land Rover</option>
                    <option value="8">Mercedes</option>
                    <option value="9">Mini</option>
                    <option value="10">Nissan</option>
                    <option value="11">Toyota</option>
                    <option value="12">Volvo</option>
                </select>
                <span class="form__label">Car picker</span>
                <span class="form__error">Error message</span>
            </label>

            <!-- file -->
            <label class="form__item">
                <input class="form__input form__input--file" tabindex="-1" type="file" id="avatar" name="avatar" accept="image/png, image/jpeg"
                    required />
                <!-- not button important -->
                <div class="form__btn--file" tabindex="0">
                    <div class="form__btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 17" width="16" height="14">
                            <path d="M10 0L4.8 4.9h3.3V10h3.8V4.9h3.3L10 0zm9.3 11.5l-3.2-2.1h-2l3.4 2.6H14c-.1 0-.2.1-.2.1l-.8 2.3H7l-.8-2.2c-.1-.1-.1-.2-.2-.2H2.4l3.4-2.6h-2L.6 11.5c-.4.3-.7 1-.6 1.5l.6 3.1c.1.5.7.9 1.2.9h16.3c.6 0 1.1-.4 1.3-.9L20 13c.1-.5-.2-1.2-.7-1.5z" />
                        </svg> Choose a file...
                    </div>
                    <span class="form__file-paceholder"></span>
                </div>
                <span class="form__label">Pick logo</span>
                <span class="form__error">Error message</span>
            </label>

            <!-- date -->
            <label class="form__item">
                <input required class="form__input" placeholder="date" type="date" />
                <span class="form__label">Date</span>
                <span class="form__error">Error message</span>
            </label>

            <!-- datetime-local -->
            <label class="form__item">
                <input required class="form__input" placeholder="datetime-local" type="datetime-local" />
                <span class="form__label">Datetime-local</span>
                <span class="form__error">Error message</span>
            </label>

            <!-- week -->
            <label class="form__item">
                <input required class="form__input" placeholder="week" type="week" />
                <span class="form__label">Week</span>
                <span class="form__error">Error message</span>
            </label>

            <!-- month -->
            <label class="form__item">
                <input required class="form__input" placeholder="month" type="month" />
                <span class="form__label">Month</span>
                <span class="form__error">Error message</span>
            </label>

            <!-- actions -->
            <div class="form__item form__item--actions">
                <button class="form__btn form__btn--link" type="button">Cancel</button>
                <button class="form__btn btn form__btn--primary" type="submit">
                    <span class="btn__text">Submit</span>
                    <img class="btn__spinner" src="./spinner.svg">
                </button>
            </div>
        </fieldset>
    </form>

    <form class="form" action="/action_page.php">
        <h2 class="form__title">Controls that can't be invalid</h2>
        <!-- demo: disabled -->
        <fieldset class="form__fieldset">
            <!-- range -->
            <label class="form__item">
                <input required min="4" value="-1" class="form__input form__input--range" type="range" />
                <span class="form__label">Range</span>
                <span class="form__error">Error message</span>
            </label>

            <!-- color -->
            <label class="form__item">
                <input required class="form__input" placeholder="color" type="color" />
                <span class="form__label">Color</span>
                <span class="form__error">Error message</span>
            </label>

            <!-- actions -->
            <div class="form__item form__item--actions">
                <button class="form__btn form__btn--link" type="button">Cancel</button>
                <button class="form__btn btn form__btn--primary" type="submit">
                    <span class="btn__text">Submit</span>
                    <img class="btn__spinner" src="./spinner.svg">
                </button>
            </div>
        </fieldset>
    </form>

    <form class="form" action="/action_page.php">
        <h2 class="form__title">Controls that can't be invalid</h2>
        <!-- demo: disabled -->
        <fieldset class="form__fieldset">
            <!-- search -->
            <label class="form__item">
                <input required class="form__input" placeholder="search" type="search" />
                <span class="form__label">Search</span>
                <span class="form__error">Error message</span>
            </label>

            <!-- tel -->
            <label class="form__item">
                <input required class="form__input" placeholder="tel" type="tel" />
                <span class="form__label">Tel</span>
                <span class="form__error">Error message</span>
            </label>

            <!-- url -->
            <label class="form__item">
                <input required class="form__input" placeholder="url" type="url" />
                <span class="form__label">Url</span>
                <span class="form__error">Error message</span>
            </label>

            <!-- password -->
            <label class="form__item">
                <input required class="form__input" placeholder="password" type="password" />
                <span class="form__label">Password</span>
                <span class="form__error">Error message</span>
            </label>

            <!-- datetime -->
            <label class="form__item">
                <input required class="form__input" placeholder="datetime" type="datetime" />
                <span class="form__label">Datetime</span>
                <span class="form__error">Error message</span>
            </label>



            <!-- email -->
            <label class="form__item">
                <input required class="form__input" placeholder="email" type="email" />
                <span class="form__label">Email</span>
                <span class="form__error">Error message</span>
            </label>

            <!-- demo: valid check after input -->
            <label class="form__item">
                <input class="form__input form__input--with_valid" type="text" placeholder="Jarry Muer" required
                    pattern="[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*" />
                <span class="form__valid">ok</span>
                <span class="form__label">Name</span>
                <span class="form__error">Error message</span>
            </label>

            <!-- actions -->
            <div class="form__item form__item--actions">
                <button class="form__btn form__btn--link" type="button">Cancel</button>
                <button class="form__btn btn form__btn--primary" type="submit">
                    <span class="btn__text">Submit</span>
                    <img class="btn__spinner" src="./spinner.svg">
                </button>
            </div>
        </fieldset>
    </form>
    <script>
        initSelect();
        initFilePicker();

        // jquery like functions
        const getSiblings = (el, filter) => {
            var siblings = [];
            el = el.parentNode.firstChild;
            do { if (!filter || filter(el)) siblings.push(el); } while (el = el.nextSibling);
            return siblings;
        };



        const setInputFocus = (input) => {
            if (input.tagName === 'SELECT' ||
                ['checkbox', 'radio', 'file'].includes(input.type)) {
                if (input.parentNode.getAttribute('tabindex') == 0) {
                    input.parentNode.focus();
                } else {
                    const nodes = getSiblings(input, (e)=> {
                        return e.getAttribute && e.getAttribute('tabindex') == 0;
                    });

                    if (nodes.length) {
                        nodes[0].focus();
                    }
                }
            } else {
                input.focus();
            }
        }



        const setInputErrorMessage = (input) => {
            const forErrors = getSiblings(input, (e)=> {
                // classList can be text :)
                return e.classList && e.classList.contains('form__error');
            });

            if (forErrors.length) {
                forErrors[0].innerText = input.validationMessage;
            }
        }



        const checkInputValidity = (input) => {
            if (!input.checkValidity()) {
                setInputErrorMessage(input);

                input.removeAttribute('valid');
                input.setAttribute('invalid', true);

                return input;
            } else {
                input.removeAttribute('invalid');
                input.setAttribute('valid', true);
            }
        }



        // // select fix
        function selectFixValidation() {
            const select = document.querySelector('select');

            function setRightValidityAttribute() {
                console.log(this);
                checkInputValidity(this);
            }

            select.addEventListener('change', setRightValidityAttribute);
        }

        selectFixValidation();



        // // long operation emulation
        function doThomethingAndReturnThePromise() {
            return new Promise((res) => setTimeout(res, 1500));
        }



        // // on sumbmit hooks
        function onSubmitHooks() {
            const forms = Array.from(document.querySelectorAll('form'));

            forms.forEach(form => {
                const fieldset = form.querySelector('fieldset');
                const inputs = Array.from(form.querySelectorAll('input, select'));

                const onSubmit = (e) => {
                    // prevent form sumbitting
                    e.preventDefault();
                    const input = inputs.find(checkInputValidity);
                    if (input) {
                        setInputFocus(input);
                    } else {
                        fieldset.setAttribute('disabled', true);
                        doThomethingAndReturnThePromise().finally(()=> {
                            fieldset.removeAttribute('disabled');
                        });
                    }
                };

                form.addEventListener('submit', onSubmit);
                form.setAttribute('novalidate', true);
            });
        }

        onSubmitHooks();


        // // fix notouch issue
        function nonTouchedFix() {
            const inputsHaveToBeUntouchedByDefault = Array.from(document.querySelectorAll(`
                [type=checkbox],
                [type=radio],
                [type=week],
                [type=month],
                [type=date],
                [type=datetime-local],
                [type=file]`
            ));

            function removeAttribute() {
                this.removeAttribute('untouched');
                this.removeEventListener('blur', removeAttribute);
            };

            inputsHaveToBeUntouchedByDefault.forEach(e => {
                e.setAttribute('untouched', true);
                e.addEventListener('blur', removeAttribute);
            });
        }

        nonTouchedFix();


        // // prettify error messages
        function renderErrorMessageOnInput() {
            // to check why not working
            // const inputs = Array.from(document.querySelectorAll('input'));
            const inputs = Array.from(document.querySelectorAll(`
                input:not([type=datetime-local]):not([type=date]):not([type=month]):not([type=week])
            `));

            const strangeInputs = Array.from(document.querySelectorAll(`
                [type=datetime-local],
                [type=date],
                [type=month],
                [type=week]`));

            function onInput() {
                setInputErrorMessage(this);
            }

            inputs.forEach(input => {
                input.addEventListener('input', onInput);
            });

            strangeInputs.forEach(input => {
                input.addEventListener('blur', onInput);
            });

            [].concat(strangeInputs, inputs).forEach(e => {
                onInput.call(e);
            })
        }

        renderErrorMessageOnInput();

    </script>
</body>

</html>
